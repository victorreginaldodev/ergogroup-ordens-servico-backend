{% extends 'ordemServico/base.html' %}
{% load static %}
{% block title %} Painel de controle {% endblock %}
{% block style %}
<style>
    .status-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .status-concluido {
        background-color: #a8d5ba; /* Verde pastel */
        color: #155724; /* Verde escuro para texto */
    }

    .status-em-andamento {
        background-color: #fff3cd; /* Amarelo pastel */
        color: #856404; /* Amarelo escuro para texto */
    }

    .status-em-espera {
        background-color: #f8d7da; /* Vermelho pastel */
        color: #721c24; /* Vermelho escuro para texto */
    }

    .status-cell {
        padding: 8px;
        text-align: center;
        border-radius: 4px;
    }


</style>
{% endblock %}

{% block content %}
<div class="content page-title mb-5 px-4" style="min-height: 80vh;">

    <div class="container">
        <h3 class="titulo-pagina">
            <i class="bi bi-graph-up" style="margin-right: 4px;"></i>
            Painel de controle
        </h3>

        <!-- Gráfico 1: Quantidade de serviços criados por mês -->
        <div class="mb-4 P-3" style="width: 100%; height: 40vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: var(--cinza-claro); border-radius: 12px;">
            <h4 style="color: var(--cinza); font-weight: 500; padding: 1rem;">GRÁFICO DE SERVIÇOS CRIADOS POR MÊS</h4>
            <canvas id="graficoServicosPorMes" style="max-width: 90%; max-height: 90%;"></canvas>
        </div>

        <!-- Container para os gráficos de status e vendas -->
        <div class="mb-4" style="display: flex; justify-content: space-between; align-items: center; width: 100%; height: 40vh;">
            <!-- Gráfico 2: Quantidade de serviços por status -->
            <div style="width: 30%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: var(--cinza-claro); border-radius: 12px;">
                <h4 style="color: var(--cinza); font-weight: 500; padding: 1rem;">GRÁFICO DE STATUS DOS SERVIÇOS</h4>
                <canvas id="graficoServicosPorStatus" style="max-width: 90%; max-height: 90%;"></canvas>
            </div>

            <!-- Gráfico 3: Valor de vendas por mês -->
            <div style="width: 68%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: var(--cinza-claro); border-radius: 12px;">
                <h4 style="color: var(--cinza); font-weight: 500; padding: 1rem;">GRÁFICO DE VENDAS MENSAIS</h4>
                <canvas id="graficoVendasPorMes" style="max-width: 90%; max-height: 90%;"></canvas>
            </div>
        </div>

        <h6 style="color: #78828B; font-weight: 400; font-size: 14px;" class="mb-2">
            Histórico de serviços:
        </h6>

        <div style="display: flex; align-items: center; gap: 10px;" class="mb-1">
            <!-- Campo de Pesquisa -->
            <input type="text" id="search-input" class="form-control w-50" placeholder="Pesquisar..." style=" padding: 0.5rem; font-size: 14px; background-color: var(--cinza-claro);">
        
            <!-- Botões de Filtro -->
            <button onclick="filterTable('concluída')" 
                    style="
                        display: inline-flex;
                        align-items: center;
                        padding: 8px 16px;
                        border-radius: 16px;
                        border: 1px solid #28a745;
                        background-color: #f0fdf4;
                        color: #155724;
                        font-size: 12px;
                        cursor: pointer;
                        font-weight: bold;">
                <span style="
                        display: inline-block;
                        width: 10px;
                        height: 10px;
                        border-radius: 50%;
                        margin-right: 8px;
                        background-color: #28a745;">
                </span>
                Concluído
            </button>
        
            <button onclick="filterTable('em andamento')" 
                    style="
                        display: inline-flex;
                        align-items: center;
                        padding: 8px 16px;
                        border-radius: 16px;
                        border: 1px solid #ffc107;
                        background-color: #fff8e1;
                        color: #856404;
                        font-size: 12px;
                        cursor: pointer;
                        font-weight: bold;">
                <span style="
                        display: inline-block;
                        width: 10px;
                        height: 10px;
                        border-radius: 50%;
                        margin-right: 8px;
                        background-color: #ffc107;">
                </span>
                Em andamento
            </button>
        
            <button onclick="filterTable('em espera')" 
                    style="
                        display: inline-flex;
                        align-items: center;
                        padding: 8px 16px;
                        border-radius: 16px;
                        border: 1px solid #dc3545;
                        background-color: #fde2e4;
                        color: #721c24;
                        font-size: 12px;
                        cursor: pointer;
                        font-weight: bold;">
                <span style="
                        display: inline-block;
                        width: 10px;
                        height: 10px;
                        border-radius: 50%;
                        margin-right: 8px;
                        background-color: #dc3545;">
                </span>
                Em espera
            </button>
        
            <button onclick="filterTable('')" 
                    style="
                        display: inline-flex;
                        align-items: center;
                        padding: 8px 16px;
                        border-radius: 16px;
                        border: 1px solid #6c757d;
                        background-color: #f8f9fa;
                        color: #6c757d;
                        font-size: 12px;
                        cursor: pointer;
                        font-weight: bold;">
                <span style="
                        display: inline-block;
                        width: 10px;
                        height: 10px;
                        border-radius: 50%;
                        margin-right: 8px;
                        background-color: #6c757d;">
                </span>
                Todos
            </button>
        </div>

        <div class="tabela-painel-controle p-1" style="max-height: 50vh; overflow-y: auto;">
            <table class="table table-hover" id="data-table">
                <thead>
                    <tr style="font-size: 12px; text-align: center;">
                        <th scope="col" style="background-color: var(--azul-principal); color: var(--cinza-claro); padding: 0.75rem; border-top-left-radius: 12px; border-bottom-left-radius: 12px;">CLIENTE</th>
                        <th scope="col" style="background-color: var(--azul-principal); color: var(--cinza-claro); padding: 0.75rem;">SERVIÇO</th>
                        <th scope="col" style="background-color: var(--azul-principal); color: var(--cinza-claro); padding: 0.75rem;">RECEBIMENTO</th>
                        <th scope="col" style="background-color: var(--azul-principal); color: var(--cinza-claro); padding: 0.75rem;">CONCLUSÃO</th>
                        <th scope="col" style="background-color: var(--azul-principal); color: var(--cinza-claro); padding: 0.75rem; border-top-right-radius: 12px; border-bottom-right-radius: 12px;">STATUS</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Renderiza os dados iniciais da primeira página -->
                    {% for servico in page_obj %}
                    <tr id="servico-{{ servico.id }}"
                        style="font-size: 12px; text-align: center; border-bottom: 3px solid var(--cinza-claro); cursor: pointer;"
                        data-status="{{ servico.get_status_display|lower }}"
                        data-id="{{ servico.id }}"
                        onclick="openServiceModal(this)">
                        <td style="padding: 0.75rem;">{{ servico.ordem_servico.cliente.nome|truncatechars:40|upper }}</td>
                        <td>{{ servico.repositorio.nome|truncatechars:20|upper }}</td>
                        <td>{{ servico.ordem_servico.data_criacao|date:"d/m/Y" }}</td>
                        <td>
                            {% if servico.data_conclusao %}
                            {{ servico.data_conclusao|date:"d/m/Y" }}
                            {% else %}
                            NÃO CONCLUÍDO
                            {% endif %}
                        </td>
                        <td style="text-align: center;">
                            <span style="
                                display: inline-flex; 
                                align-items: center; 
                                padding: 4px 8px; 
                                border-radius: 16px; 
                                border: 1px solid 
                                    {% if servico.get_status_display|lower == 'concluída' %}#28a745{% endif %}
                                    {% if servico.get_status_display|lower == 'em andamento' %}#ffc107{% endif %}
                                    {% if servico.get_status_display|lower == 'em espera' %}#dc3545{% endif %};
                                background-color: 
                                    {% if servico.get_status_display|lower == 'concluída' %}#f0fdf4{% endif %}
                                    {% if servico.get_status_display|lower == 'em andamento' %}#fff8e1{% endif %}
                                    {% if servico.get_status_display|lower == 'em espera' %}#fde2e4{% endif %};
                                color: 
                                    {% if servico.get_status_display|lower == 'concluída' %}#155724{% endif %}
                                    {% if servico.get_status_display|lower == 'em andamento' %}#856404{% endif %}
                                    {% if servico.get_status_display|lower == 'em espera' %}#721c24{% endif %};
                            ">
                                <span style="
                                    display: inline-block; 
                                    width: 10px; 
                                    height: 10px; 
                                    border-radius: 50%; 
                                    margin-right: 8px; 
                                    background-color: 
                                        {% if servico.get_status_display|lower == 'concluída' %}#28a745{% endif %}
                                        {% if servico.get_status_display|lower == 'em andamento' %}#ffc107{% endif %}
                                        {% if servico.get_status_display|lower == 'em espera' %}#dc3545{% endif %};
                                ">
                                </span>
                                {{ servico.get_status_display|upper }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Controles de Paginação -->
        <div class="pagination d-flex justify-content-center align-items-center mt-3">
            {% if page_obj.has_previous %}
                <button class="button" onclick="loadTableData('/painel/dados/?page={{ page_obj.previous_page_number }}')">Anterior</button>
            {% endif %}
            <span class="mx-3">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
            {% if page_obj.has_next %}
                <button class="button" onclick="loadTableData('/painel/dados/?page={{ page_obj.next_page_number }}')">Próxima</button>
            {% endif %}
        </div>
           
    </div>
</div>

<!-- Modal completa no template painel_controle.html -->
<div class="modal fade" id="serviceDetailsModal" tabindex="-1" aria-labelledby="serviceDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="max-width: 90%;">
        <div class="modal-content">
            <!-- Cabeçalho da Modal -->
            <div class="modal-header p-3">
                <h5 class="modal-title" id="serviceDetailsModalLabel" style="color: var(--cinza); font-weight: 600;">Detalhes do Serviço</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            
            <!-- Corpo da Modal -->
            <div class="modal-body p-3" id="serviceDetailsContent">
                <!-- Campos para dados do serviço -->
                <div class="row">
                    <div class="col-4">
                        <strong style="color: var(--cinza); font-weight: 500; font-size: 14px !important;">Cliente:</strong>
                        <p id="cliente-nome" class="mt-1" style="color: #000; font-size: 12px;">Carregando...</p>
                    </div>
                    <div class="col-4">
                        <strong style="color: var(--cinza); font-weight: 500; font-size: 14px !important;">Serviço:</strong>
                        <p id="servico-nome" class="mt-1" style="color: #000; font-size: 12px;">Carregando...</p>
                    </div>
                </div>
                <div class="row mt-5">
                    <div class="col-2">
                        <strong style="color: var(--cinza); font-weight: 500; font-size: 14px !important;">Data de Recebimento:</strong>
                        <p id="data-recebimento" class="mt-1" style="color: #000; font-size: 12px;">Carregando...</p>
                    </div>
                    <div class="col-2">
                        <strong style="color: var(--cinza); font-weight: 500; font-size: 14px !important;">Data de Conclusão:</strong>
                        <p id="data-conclusao" class="mt-1" style="color: #000; font-size: 12px;">Carregando...</p>
                    </div>
                    <div class="col-2">
                        <!-- Coloque o texto Status acima -->
                        <strong 
                            style="
                                color: var(--cinza); 
                                font-weight: 500; 
                                font-size: 14px !important; 
                                display: block; /* Garante que fique em uma nova linha */
                                margin-bottom: 4px; /* Espaçamento entre o texto Status e o conteúdo */
                            ">
                            Status:
                        </strong>
                        <!-- Coloque o conteúdo abaixo -->
                        <span id="status" style="
                            display: inline-flex;
                            align-items: center;
                            padding: 4px 8px;
                            border-radius: 16px;
                            font-weight: bold;
                            border: 1px solid transparent;
                            background-color: #f8f9fa; /* Cor padrão */
                            color: #6c757d; /* Cor padrão */
                            font-size: 12px; /* Garante o tamanho do texto principal */
                        ">
                            <span id="status-indicator" style="
                                display: inline-block;
                                width: 10px;
                                height: 10px;
                                border-radius: 50%;
                                margin-right: 8px;
                                background-color: #6c757d; /* Cor padrão */
                            "></span>
                            <span id="status-text" style="font-size: 12px;">Carregando...</span>
                        </span>
                    </div>                 
                </div>
                <div class="mt-5">
                    <strong style="color: var(--cinza); font-weight: 500; font-size: 14px !important;">Descrição:</strong>
                    <p id="descricao" class="mt-1" style="color: #000; font-size: 12px;">Carregando...</p>
                </div>
            </div>            
            
            <!-- Rodapé da Modal -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}


<script>

    /**
     * Função para carregar dinamicamente os dados da tabela com paginação e filtros.
     * Utiliza requisições AJAX para evitar o recarregamento completo da página.
     *
     * @param {string} url - URL para carregar os dados (inclui parâmetros GET).
    */

    function loadTableData(url) {
        fetch(url)
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#data-table tbody');
                tbody.innerHTML = ''; // Limpa a tabela existente

                // Adiciona os novos dados
                data.servicos.forEach(servico => {
                    const row = `
                        <tr id="servico-${servico.id}"
                            style="font-size: 12px; text-align: center; border-bottom: 3px solid var(--cinza-claro); cursor: pointer;"
                            data-id="${servico.id}"
                            onclick="openServiceModal(this)">
                            <td style="padding: 0.75rem;">${servico.ordem_servico__cliente__nome.toUpperCase()}</td>
                            <td>${servico.repositorio__nome.toUpperCase()}</td>
                            <td>${new Date(servico.ordem_servico__data_criacao).toLocaleDateString('pt-BR')}</td>
                            <td>${servico.data_conclusao ? new Date(servico.data_conclusao).toLocaleDateString('pt-BR') : 'NÃO CONCLUÍDO'}</td>
                            <td style="text-align: center;">
                                <span style="
                                    display: inline-flex;
                                    align-items: center;
                                    padding: 4px 8px;
                                    border-radius: 16px;
                                    border: 1px solid ${servico.status.toLowerCase() === 'concluída' ? '#28a745' : servico.status.toLowerCase() === 'em andamento' ? '#ffc107' : '#dc3545'};
                                    background-color: ${servico.status.toLowerCase() === 'concluída' ? '#f0fdf4' : servico.status.toLowerCase() === 'em andamento' ? '#fff8e1' : '#fde2e4'};
                                    color: ${servico.status.toLowerCase() === 'concluída' ? '#155724' : servico.status.toLowerCase() === 'em andamento' ? '#856404' : '#721c24'};
                                ">
                                    <span style="
                                        display: inline-block;
                                        width: 10px;
                                        height: 10px;
                                        border-radius: 50%;
                                        margin-right: 8px;
                                        background-color: ${servico.status.toLowerCase() === 'concluída' ? '#28a745' : servico.status.toLowerCase() === 'em andamento' ? '#ffc107' : '#dc3545'};
                                    ">
                                    </span>
                                    ${servico.status.toUpperCase()}
                                </span>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });

                // Atualiza os controles de paginação
                const pagination = document.querySelector('.pagination');
                pagination.innerHTML = ''; // Limpa os controles existentes

                if (!data.filtro_aplicado) {
                    if (data.has_previous) {
                        pagination.innerHTML += `<button class="button" onclick="loadTableData('/painel/dados/?page=${data.previous_page}')">Anterior</button>`;
                    }
                    pagination.innerHTML += `<span class="mx-3">Página ${data.current_page} de ${data.total_pages}</span>`;
                    if (data.has_next) {
                        pagination.innerHTML += `<button class="button" onclick="loadTableData('/painel/dados/?page=${data.next_page}')">Próxima</button>`;
                    }
                }
            })
            .catch(error => console.error('Erro ao carregar os dados:', error));
    }


</script>

<script>

    /**
     * Função para filtrar os dados da tabela com base em status e busca por nome.
     * Constrói a URL apropriada e chama a função de carregamento.
     *
     * @param {string} status - Status para filtrar (opcional, ex.: "concluída", "em andamento").
    */

    function filterTable(status = '') {
        const search = document.getElementById('search-input').value; // Obtém o valor do campo de busca
        const url = `/painel/dados/?search=${encodeURIComponent(search)}&status=${status}`;
        loadTableData(url); // Carrega os dados filtrados
    }

    // Evento para ativar o filtro em tempo real enquanto o usuário digita no campo de busca
    document.getElementById('search-input').addEventListener('keyup', () => filterTable());

</script>

<script>

    /**
     * Função para abrir a modal e carregar os detalhes do serviço.
     * @param {HTMLElement} row - Linha da tabela que foi clicada.
    */

    function openServiceModal(row) {
        const serviceId = row.getAttribute('data-id'); // Obtém o ID do serviço da linha
        const modal = new bootstrap.Modal(document.getElementById('serviceDetailsModal')); // Inicializa a modal

        // Faz uma requisição AJAX para buscar os detalhes do serviço
        fetch(`/servico/${serviceId}/`)
            .then(response => response.json())
            .then(data => {
                // Preenche os campos da modal com os dados do serviço
                document.getElementById('cliente-nome').textContent = data.cliente || 'Não informado';
                document.getElementById('servico-nome').textContent = data.servico || 'Não informado';
                document.getElementById('data-recebimento').textContent = data.data_recebimento || 'Não informado';
                document.getElementById('data-conclusao').textContent = data.data_conclusao || 'Não informado';
                document.getElementById('descricao').textContent = data.descricao || 'Não informado';

                // Atualiza o status com cores e texto apropriados
                const statusSpan = document.getElementById('status');
                const statusIndicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');

                statusText.textContent = data.status || 'Desconhecido';

                // Define cores para o status
                if (data.status === 'Concluída') {
                    statusSpan.style.backgroundColor = '#f0fdf4';
                    statusSpan.style.color = '#155724';
                    statusIndicator.style.backgroundColor = '#28a745';
                } else if (data.status === 'Em andamento') {
                    statusSpan.style.backgroundColor = '#fff8e1';
                    statusSpan.style.color = '#856404';
                    statusIndicator.style.backgroundColor = '#ffc107';
                } else if (data.status === 'Em espera') {
                    statusSpan.style.backgroundColor = '#fde2e4';
                    statusSpan.style.color = '#721c24';
                    statusIndicator.style.backgroundColor = '#dc3545';
                } else {
                    // Cor padrão para status desconhecido
                    statusSpan.style.backgroundColor = '#f8f9fa';
                    statusSpan.style.color = '#6c757d';
                    statusIndicator.style.backgroundColor = '#6c757d';
                }

                // Abre a modal
                modal.show();
            })
            .catch(error => {
                console.error('Erro ao carregar os detalhes do serviço:', error);
                alert('Não foi possível carregar os detalhes do serviço. Tente novamente.');
            });
    }

</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<script>
    // Requisição para obter os dados
    fetch('/api/servicos-graficos/')
        .then(response => response.json())
        .then(data => {
            // Função para criar um degradê
            const criarDegrade = (ctx, cor1, cor2) => {
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, cor1);
                gradient.addColorStop(1, cor2);
                return gradient;
            };

            // Gráfico de serviços criados por mês
            const labelsServicosPorMes = data.servicos_por_mes.map(item => {
                const date = new Date(item.mes);
                return `${date.getMonth() + 1}/${date.getFullYear()}`;
            });
            const dataServicosPorMes = data.servicos_por_mes.map(item => item.total);

            const ctx1 = document.getElementById('graficoServicosPorMes').getContext('2d');
            const gradient1 = criarDegrade(ctx1, '#2A6CB2', '#0BB4ED');
            new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: labelsServicosPorMes,
                    datasets: [{
                        data: dataServicosPorMes,
                        backgroundColor: gradient1,
                        borderColor: '#2A6CB2',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false // Remove a legenda
                        },
                        tooltip: {
                            callbacks: {
                                label: function (tooltipItem) {
                                    return `Total: ${tooltipItem.raw}`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            anchor: 'center',
                            align: 'center',
                            formatter: (value) => value
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // Gráfico de serviços por status (gráfico de pizza)
            const labelsServicosPorStatus = ['EM ESPERA', 'EM ANDAMENTO', 'CONCLUÍDA'];
            const coresPastel = ['#f8d7da', '#fff3cd', '#d4edda']; // Vermelho, amarelo e verde pastéis

            // Garante que os dados estejam na ordem correta
            const dataServicosPorStatus = [0, 0, 0]; // Inicializa com 0 para cada status
            data.servicos_por_status.forEach(item => {
                switch (item.status) {
                    case 'em_espera':
                        dataServicosPorStatus[0] = item.total; // Total para "em_espera"
                        break;
                    case 'em_andamento':
                        dataServicosPorStatus[1] = item.total; // Total para "em_andamento"
                        break;
                    case 'concluida':
                        dataServicosPorStatus[2] = item.total; // Total para "concluida"
                        break;
                }
            });

            const ctx2 = document.getElementById('graficoServicosPorStatus').getContext('2d');
            new Chart(ctx2, {
                type: 'pie',
                data: {
                    labels: labelsServicosPorStatus,
                    datasets: [{
                        data: dataServicosPorStatus,
                        backgroundColor: coresPastel,
                        borderColor: '#FFFFFF',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right', // Posiciona a legenda à direita
                            labels: {
                                usePointStyle: true, // Usa bolinhas na legenda
                                pointStyle: 'circle' // Define o estilo como círculo
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (tooltipItem) {
                                    const label = tooltipItem.label || '';
                                    const value = tooltipItem.raw || 0;
                                    return `${label}: ${value} serviços`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#000000', // Cor do texto sobre a fatia
                            anchor: 'end',
                            align: 'start',
                            formatter: (value) => `${value}`, // Exibe apenas o número
                            font: {
                                weight: 'bold',
                                size: 12
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels] // Certifique-se de carregar o plugin ChartDataLabels
            });

            // Gráfico de vendas por mês
            const labelsVendasPorMes = data.vendas_por_mes.map(item => {
                const date = new Date(item.mes);
                return `${date.getMonth() + 1}/${date.getFullYear()}`;
            });
            const dataVendasPorMes = data.vendas_por_mes.map(item => item.total_vendas);

            const ctx3 = document.getElementById('graficoVendasPorMes').getContext('2d');
            const gradient3 = criarDegrade(ctx3, '#2A6CB2', '#0BB4ED');
            new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: labelsVendasPorMes,
                    datasets: [{
                        data: dataVendasPorMes,
                        backgroundColor: gradient3,
                        borderColor: '#2A6CB2',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false // Remove a legenda
                        },
                        tooltip: {
                            callbacks: {
                                label: function (tooltipItem) {
                                    return `R$ ${tooltipItem.raw.toLocaleString('pt-BR', {
                                        style: 'currency',
                                        currency: 'BRL'
                                    })}`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            anchor: 'center',
                            align: 'center',
                            formatter: (value) => value.toLocaleString('pt-BR', {
                                style: 'currency',
                                currency: 'BRL'
                            }),
                            font: {
                                weight: 'bold',
                                size: 12
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        })
        .catch(error => console.error('Erro ao carregar os dados dos gráficos:', error));
</script>

<script>
    function openServiceModal(row) {
        const serviceId = row.getAttribute('data-id');
        const modal = new bootstrap.Modal(document.getElementById('serviceDetailsModal'));
        const modalBody = document.getElementById('serviceDetailsContent');
    
        // Exibe a modal
        modal.show();
    
        // Reseta os campos para o estado inicial
        document.getElementById('status-text').textContent = 'Carregando...';
        document.getElementById('status').style.backgroundColor = '#f8f9fa';
        document.getElementById('status').style.borderColor = 'transparent';
        document.getElementById('status').style.color = '#6c757d';
        document.getElementById('status-indicator').style.backgroundColor = '#6c757d';
        document.getElementById('status-text').style.fontSize = '12px'; // Aplica o tamanho inline diretamente
    
        // Faz a requisição para obter os dados do serviço
        fetch(`/servico/${serviceId}/`)
            .then(response => {
                if (!response.ok) throw new Error('Erro ao carregar os detalhes do serviço.');
                return response.json(); // Retorna os dados como JSON
            })
            .then(data => {
                // Atualiza outros campos
                document.getElementById('cliente-nome').textContent = data.cliente;
                document.getElementById('servico-nome').textContent = data.servico;
                document.getElementById('data-recebimento').textContent = data.data_recebimento;
                document.getElementById('data-conclusao').textContent = data.data_conclusao || 'NÃO CONCLUÍDO';
                document.getElementById('descricao').textContent = data.descricao;
    
                // Atualiza o campo de status com texto e estilos
                const statusElement = document.getElementById('status');
                const statusIndicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
    
                statusText.textContent = data.status;
    
                // Define os estilos com base no status
                if (data.status.toLowerCase() === 'concluída') {
                    statusElement.style.color = '#155724';
                    statusElement.style.backgroundColor = '#f0fdf4';
                    statusElement.style.borderColor = '#28a745';
                    statusIndicator.style.backgroundColor = '#28a745';
                } else if (data.status.toLowerCase() === 'em andamento') {
                    statusElement.style.color = '#856404';
                    statusElement.style.backgroundColor = '#fff8e1';
                    statusElement.style.borderColor = '#ffc107';
                    statusIndicator.style.backgroundColor = '#ffc107';
                } else if (data.status.toLowerCase() === 'em espera') {
                    statusElement.style.color = '#721c24';
                    statusElement.style.backgroundColor = '#fde2e4';
                    statusElement.style.borderColor = '#dc3545';
                    statusIndicator.style.backgroundColor = '#dc3545';
                }
            })
            .catch(error => {
                modalBody.innerHTML = `<p class="text-danger text-center">${error.message}</p>`;
            });
    }
</script>
    
{% endblock %}