{% extends 'ordemServico/base.html' %}
{% load static %}
{% block title %} Técnico {% endblock %}
{% block content %}

<div class="content page-title container mb-5">

    <h3 class="titulo-pagina">
        <i class="fa-solid fa-helmet-safety" style="margin-right: 4px;"></i>
        Página do Engenheiro e do Técnico
    </h3>

    <div class="pesquisar" style="display: flex; align-items: center;">
        <form action="{% url 'financeiro' %}" method="get" style="flex: 1;">
            <div class="input-group mb-1">
                <input type="text" id="searchInput" name="nome_empresa" class="form-control" placeholder="Pesquise pelo nome da empresa..." value="{{ nome_empresa }}">
            </div>
        </form>
        <div class="ms-3 mb-3">

            <button class="btn button px-3 py-1 mt-2 visualizar-btn" id="nao_iniciado">
                Novos serviços: {{ qtd_tarefas_nao_iniciadas }}
            </button>
            <button class="btn button px-3 py-1 mt-2 visualizar-btn" id="em_andamento">
                Em andamento: {{ qtd_tarefas_em_andamento }}
            </button>
            <button class="btn button px-3 py-1 mt-2 visualizar-btn"  id="concluido">
                Finalizados: {{ qtd_tarefas_finalizadas }}
            </button>
        </div>
    </div>

    {% for tarefa in tarefas_nao_iniciadas %}
    <div class="nao_iniciado" style="display: block;">

        <div class="accordion mb-1" id="accordion-{{ tarefa.servico.id }}">

            <div class="accordion-item">

                <h2 class="accordion-header" id="heading-{{ tarefa.servico.id }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapse-{{ servico.id }}" aria-expanded="false"
                        aria-controls="collapse-{{ tarefa.servico.id }}">

                        <div class="acordeao">
                            <div class="accordion-header-items">
                                <p>OS Nº:</p>{{ tarefa.servico.ordem_servico.id }}
                            </div>
                            <div class="accordion-header-items" style="border: none;">
                                <p>CLIENTE:</p>{{ tarefa.servico.ordem_servico.cliente.nome|truncatechars:30 }}
                            </div>
                        </div>
                    </button>
                </h2>

                <div id="collapse-{{ tarefa.servico.id }}" class="accordion-collapse collapse"
                    aria-labelledby="heading-{{ tarefa.servico.id }}"
                    data-bs-parent="#accordion-{{ tarefa.servico.id }}">

                    <div class="accordion-body">

                        <div class="accordion-infos">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Cliente:</label>
                                    <p>{{ tarefa.servico.ordem_servico.cliente.nome|truncatechars:30 }}</p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Número da inscrição:</label> 
                                    <p>{{ tarefa.servico.ordem_servico.cliente.numero_inscricao }}</p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Nome do Representante:</label> 
                                    <p>{{ tarefa.servico.ordem_servico.cliente.nome_representante|default_if_none:"Não cadastrado" }}</p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">E-mail do Representante:</label>
                                    <p>{{ tarefa.servico.ordem_servico.cliente.email_representante|default_if_none:"Não cadastrado" }}</p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Telefone do Representante:</label>
                                    <p>{{ tarefa.servico.ordem_servico.cliente.contato_representante|default_if_none:"Não cadastrado" }}</p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Serviço:</label>
                                    <p>{{ tarefa.servico.repositorio}}</p>
                                </div>
                            </div>

                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label class="form-label">Descrição da ordem de serviço:</label>
                                    <p class="accordion-observacao">{{ tarefa.servico.descricao }}</p>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Descrição da tarefa:</label>
                                    <p class="accordion-observacao">{{ tarefa.descricao }}</p>
                                </div>
                            </div>
                        </div>

                        <form method="POST">
                            {% csrf_token %}
                            
                            <div class="row">
                                <!-- Status -->
                                <div class="col-3">
                                    <div class="mb-3">
                                        <label for="{{ formUpdate.status.id_for_label }}" class="form-label">Atualizar status</label>
                                        <select name="status" id="{{ formUpdate.status.id_for_label }}" class="form-select">
                                            <option value="nao_iniciada" {% if tarefa.status == 'nao_iniciada' %}selected{% endif %}>Não Iniciada</option>
                                            <option value="em_andamento" {% if tarefa.status == 'em_andamento' %}selected{% endif %}>Em Andamento</option>
                                            <option value="concluida" {% if tarefa.status == 'concluida' %}selected{% endif %}>Concluída</option>
                                        </select>
                                    </div>
                                </div>
                            
                                <!-- Data de Início -->
                                <div class="col-3">
                                    <div class="mb-3">
                                        <label for="data_inicio" class="form-label">Data de início</label>
                                        <input type="date" class="form-control w-100" id="data_inicio" name="data_inicio" value="{{ tarefa.data_inicio|date:'Y-m-d' }}">
                                    </div>
                                </div>
                            
                                <!-- Data de Término -->
                                <div class="col-3">
                                    <div class="mb-3">
                                        <label for="data_termino" class="form-label">Data de término</label>
                                        <input type="date" class="form-control w-100" id="data_termino" name="data_termino" value="{{ tarefa.data_termino|date:'Y-m-d' }}">
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn button p-2">Atualizar Tarefa</button>
                            <input type="hidden" name="tarefa_id" value="{{ tarefa.id }}">
                        </form>  

                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    {% for tarefa in tarefas_em_andamento %}
    <div class="px-5 em_andamento" style="display: none;">

        <div class="accordion mb-1" id="accordion-{{ tarefa.servico.id }}">

            <div class="accordion-item">

                <h2 class="accordion-header" id="heading-{{ tarefa.servico.id }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapse-{{ servico.id }}" aria-expanded="false"
                        aria-controls="collapse-{{ tarefa.servico.id }}">

                        <div class="acordeao">
                            <div class="accordion-header-items">
                                <p>OS Nº:</p>{{ tarefa.servico.ordem_servico.id }}
                            </div>
                            <div class="accordion-header-items" style="border: none;">
                                <p>CLIENTE:</p>{{ tarefa.servico.ordem_servico.cliente.nome|truncatechars:30 }}
                            </div>
                        </div>

                    </button>
                </h2>

                <div id="collapse-{{ tarefa.servico.id }}" class="accordion-collapse collapse"
                    aria-labelledby="heading-{{ tarefa.servico.id }}"
                    data-bs-parent="#accordion-{{ tarefa.servico.id }}">

                    <div class="accordion-body">

                        <div class="accordion-infos">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Cliente:</label>
                                    <p>{{ tarefa.servico.ordem_servico.cliente.nome|truncatechars:30 }}</p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Número da inscrição:</label> 
                                    <p>{{ tarefa.servico.ordem_servico.cliente.numero_inscricao }}</p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Nome do Representante:</label> 
                                    <p>{{ tarefa.servico.ordem_servico.cliente.nome_representante|default_if_none:"Não cadastrado" }}</p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">E-mail do Representante:</label>
                                    <p>{{ tarefa.servico.ordem_servico.cliente.email_representante|default_if_none:"Não cadastrado" }}</p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Telefone do Representante:</label>
                                    <p>{{ tarefa.servico.ordem_servico.cliente.contato_representante|default_if_none:"Não cadastrado" }}</p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Serviço:</label>
                                    <p>{{ tarefa.servico.repositorio}}</p>
                                </div>
                            </div>

                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label class="form-label">Descrição da ordem de serviço:</label>
                                    <p class="accordion-observacao">{{ tarefa.servico.descricao }}</p>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Descrição da tarefa:</label>
                                    <p class="accordion-observacao">{{ tarefa.descricao }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Formulário de atualização da tarefa -->
                        <form method="POST">
                            {% csrf_token %}
                            
                            <div class="row">
                                <!-- Status -->
                                <div class="col-3">
                                    <div class="mb-3">
                                        <label for="{{ formUpdate.status.id_for_label }}" class="form-label">Atualizar status</label>
                                        <select name="status" id="{{ formUpdate.status.id_for_label }}" class="form-select">
                                            <option value="nao_iniciada" {% if tarefa.status == 'nao_iniciada' %}selected{% endif %}>Não Iniciada</option>
                                            <option value="em_andamento" {% if tarefa.status == 'em_andamento' %}selected{% endif %}>Em Andamento</option>
                                            <option value="concluida" {% if tarefa.status == 'concluida' %}selected{% endif %}>Concluída</option>
                                        </select>
                                    </div>
                                </div>
                            
                                <!-- Data de Início -->
                                <div class="col-3">
                                    <div class="mb-3">
                                        <label for="data_inicio" class="form-label">Data de início</label>
                                        <input type="date" class="form-control w-100" id="data_inicio" name="data_inicio" value="{{ tarefa.data_inicio|date:'Y-m-d' }}">
                                    </div>
                                </div>
                            
                                <!-- Data de Término -->
                                <div class="col-3">
                                    <div class="mb-3">
                                        <label for="data_termino" class="form-label">Data de término</label>
                                        <input type="date" class="form-control w-100" id="data_termino" name="data_termino" value="{{ tarefa.data_termino|date:'Y-m-d' }}">
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn button p-2">Atualizar Tarefa</button>
                            <input type="hidden" name="tarefa_id" value="{{ tarefa.id }}">
                        </form>                      
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    {% for tarefa in tarefas_finalizadas %}
    <div class="px-5 concluido" style="display: none;">

        <div class="accordion mb-1" id="accordion-{{ tarefa.servico.id }}">

            <div class="accordion-item">

                <h2 class="accordion-header" id="heading-{{ tarefa.servico.id }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapse-{{ servico.id }}" aria-expanded="false"
                        aria-controls="collapse-{{ tarefa.servico.id }}">

                        <div class="acordeao">
                            <div class="accordion-header-items">
                                <p>OS Nº:</p>{{ tarefa.servico.ordem_servico.id }}
                            </div>
                            <div class="accordion-header-items" style="border: none;">
                                <p>Cliente:</p>{{ tarefa.servico.ordem_servico.cliente.nome }}
                            </div>
                        </div>

                    </button>
                </h2>

                <div id="collapse-{{ tarefa.servico.id }}" class="accordion-collapse collapse"
                    aria-labelledby="heading-{{ tarefa.servico.id }}"
                    data-bs-parent="#accordion-{{ tarefa.servico.id }}">

                    <div class="accordion-body">

                        <div class="accordion-infos">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Cliente:</label>
                                    <p>{{ tarefa.servico.ordem_servico.cliente.nome|truncatechars:30 }}</p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Número da inscrição:</label> 
                                    <p>{{ tarefa.servico.ordem_servico.cliente.numero_inscricao }}</p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Nome do Representante:</label> 
                                    <p>{{ tarefa.servico.ordem_servico.cliente.nome_representante|default_if_none:"Não cadastrado" }}</p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">E-mail do Representante:</label>
                                    <p>{{ tarefa.servico.ordem_servico.cliente.email_representante|default_if_none:"Não cadastrado" }}</p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Telefone do Representante:</label>
                                    <p>{{ tarefa.servico.ordem_servico.cliente.contato_representante|default_if_none:"Não cadastrado" }}</p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Serviço:</label>
                                    <p>{{ tarefa.servico.repositorio}}</p>
                                </div>
                            </div>

                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label class="form-label">Descrição da ordem de serviço:</label>
                                    <p class="accordion-observacao">{{ tarefa.servico.descricao }}</p>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Descrição da tarefa:</label>
                                    <p class="accordion-observacao">{{ tarefa.descricao }}</p>
                                </div>
                            </div>

                            <form method="POST">
                                {% csrf_token %}
                                
                                <div class="row">
                                    <!-- Status -->
                                    <div class="col-3">
                                        <div class="mb-3">
                                            <label for="{{ formUpdate.status.id_for_label }}" class="form-label">Atualizar status</label>
                                            <select name="status" id="{{ formUpdate.status.id_for_label }}" class="form-select">
                                                <option value="nao_iniciada" {% if tarefa.status == 'nao_iniciada' %}selected{% endif %}>Não Iniciada</option>
                                                <option value="em_andamento" {% if tarefa.status == 'em_andamento' %}selected{% endif %}>Em Andamento</option>
                                                <option value="concluida" {% if tarefa.status == 'concluida' %}selected{% endif %}>Concluída</option>
                                            </select>
                                        </div>
                                    </div>
                                
                                    <!-- Data de Início -->
                                    <div class="col-3">
                                        <div class="mb-3">
                                            <label for="data_inicio" class="form-label">Data de início</label>
                                            <input type="date" class="form-control w-100" id="data_inicio" name="data_inicio" value="{{ tarefa.data_inicio|date:'Y-m-d' }}">
                                        </div>
                                    </div>
                                
                                    <!-- Data de Término -->
                                    <div class="col-3">
                                        <div class="mb-3">
                                            <label for="data_termino" class="form-label">Data de término</label>
                                            <input type="date" class="form-control w-100" id="data_termino" name="data_termino" value="{{ tarefa.data_termino|date:'Y-m-d' }}">
                                        </div>
                                    </div>
                                </div>
    
                                <button type="submit" class="btn button p-2">Atualizar Tarefa</button>
                                <input type="hidden" name="tarefa_id" value="{{ tarefa.id }}">
                            </form>  
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

</div>

{% endblock %}

{% block scripts %}
<script>
    // script.js
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('searchInput');
        const accordionItems = document.querySelectorAll('.accordion-item');

        searchInput.addEventListener('input', function () {
            const searchTerm = searchInput.value.toLowerCase();

            accordionItems.forEach(item => {
                const header = item.querySelector('.accordion-header').textContent.toLowerCase();
                if (header.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        // Código para mostrar/esconder o conteúdo do accordion
        document.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', function () {
                const body = this.nextElementSibling;
                body.style.display = (body.style.display === 'block') ? 'none' : 'block';
            });
        });
    });

</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Obtém referências para os botões
        const btnNaoIniciado = document.getElementById('nao_iniciado');
        const btnEmAndamento = document.getElementById('em_andamento');
        const btnConcluido = document.getElementById('concluido');

        // Obtém referências para os elementos a serem exibidos/ocultados
        const naoIniciado = document.getElementsByClassName('nao_iniciado');
        const emAndamento = document.getElementsByClassName('em_andamento');
        const concluido = document.getElementsByClassName('concluido');

        function setElement(btn, elementsToShow, elementsToHide1, elementsToHide2) {
            btn.addEventListener('click', function () {
                // Oculta os elementos que não devem ser exibidos
                hideElements(elementsToHide1);
                hideElements(elementsToHide2);

                // Mostra os elementos desejados
                showElements(elementsToShow);
            });
        }

        function hideElements(elements) {
            for (let elem of elements) {
                elem.style.display = 'none';
            }
        }

        function showElements(elements) {
            for (let elem of elements) {
                elem.style.display = 'block';
            }
        }

        // Configura os eventos de clique para cada botão
        setElement(btnNaoIniciado, naoIniciado, emAndamento, concluido);
        setElement(btnEmAndamento, emAndamento, naoIniciado, concluido);
        setElement(btnConcluido, concluido, naoIniciado, emAndamento);
    });
</script>

{% endblock %}